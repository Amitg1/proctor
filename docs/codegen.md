---
layout: default
title: Code Generator
permalink: /docs/codegen/
---

A Java representation of an application's test specification can be generated by using `proctor-codegen` module. A concrete implementation of `AbstractGroups` and `AbstractGroupsManager` will be generated.
A Javascript representation can also be generated. You will need to use your Java generated code to compute group allocations and then pass them to the client side to be used with your generated Javascript.

**AbstractGroups** -
Provides an interface for consuming and accessing the groups for a user. Accessor methods are generated for each test and testbucket.

**AbstractGroupsManager** -
Provides an interface for determining the groups for a user based on the provided `Identifiers` and `context`.

## Example specification

Consider the following [ExampleGroups.json](https://gist.github.com/parker/3bb0e94b9b238b48429f#file-2-examplegroups-context-json) specification

<pre>
  <code class="javascript">    
{
    "tests" : {
        "bgcolortst": {
            "buckets": {
                "inactive":-1,
                "altcolor1":0,
                "altcolor2":1,
                "altcolor3":2,
                "altcolor4":3
            },
            "fallbackValue": -1
        }
    },
    "providedContext": {
        "country": "String",
        "loggedIn": "boolean",
        "language": "String",
        "ua": "com.indeed.example.UserAgent"
    }
}
  </code>
</pre>

### Generated ExampleGroupsManager.java

<pre>
  <code class="java">   
package com.indeed.example;

public class ExampleGroupsManager extends AbstractGroupsManager {
  public ExampleGroupsManager(final Supplier<Proctor> proctorSource) {
      super(proctorSource);
  }

  public ProctorResult determineBuckets(final Identifiers identifiers,
                                        final String country,
                                        final boolean loggedIn,
                                        final String language,
                                        final com.indeed.example.UserAgent ua);
                              
  public ProctorResult determineBuckets(final HttpServletRequest request, 
                                        final HttpServletResponse response,
                                        final Identifiers identifiers, 
                                        final boolean allowForcedGroups,
                                        final String country,
                                        final boolean loggedIn,
                                        final String language,
                                        final com.indeed.example.UserAgent ua);
}
  </code>
</pre>
<h3>Key points:</h3>

- The <strong>Supplier<Proctor> proctorSource</strong> constructor argument should provide a loaded Proctor instance. Typically, this is an implementation of <strong>AbstractProctorLoader</strong>. See [proctor-loader][Loader] for more details.
- The <strong>determineBuckets</strong> method signature contains context variables as defined in the <strong>providedContext</strong>. These automatically get mapped to their corresponding variable names in the context mapping.
- <strong>ProctorResult</strong> encapsulates the collection of test-buckets identified for each test in an application's specification. The <strong>ProctorResult</strong> is a thin wrapper around a map from <strong>testName => TestBucket</strong>. This map will only contain tests that satisfy all of the following:
  - The <strong>Identifiers</strong> contain an value for the test's <strong>test-type</strong>. If a test-type is <strong>RANDOM</strong>, it will only be included if <strong>Identifiers.randomEnabled</strong> is <strong>true'</strong>.
  - A test's <strong>eligibility-rule</strong> must have evaluated to <strong>true</strong>.
  - The test-matrix must contain a valid <strong>test-definition</strong> for the test.

### Generated ExampleGroups.java

<pre>
  <code class="java">
package com.indeed.example;

public class ExampleGroups extends AbstractGroups {
    public static final ExampleGroups EMPTY = new ExampleGroups(ProctorResult.EMPTY);

    public ExampleGroups(final ProctorResult proctorResult) {
        super(proctorResult);
    }

    public enum Test {
        BGCOLORTST("bgcolortst");
    }
    
    public enum Bgcolortst implements Bucket<Test> {
            INACTIVE(-1, "inactive"),
            ALTCOLOR1(0, "altcolor1"),
            ALTCOLOR2(1, "altcolor2"),
            ALTCOLOR3(2, "altcolor3"),
            ALTCOLOR4(3, "altcolor4");    
    }
    
    public Bgcolortst getBgcolortst();
    public int getBgcolortstValue(final int defaultValue);
    
    public boolean isBgcolortstInactive();
    public boolean isBgcolortstAltcolor1();
    public boolean isBgcolortstAltcolor2();
    public boolean isBgcolortstAltcolor3();
    public boolean isBgcolortstAltcolor4();
}
</code></pre>

<h3>Key points:</h3>

- <strong>AbstractGroups</strong> provide a application-specific meaning to each test and test-bucket.
- An <strong>enum</strong> is created for each <strong>test</strong> and corresponding <strong>group</strong>.
- Accessors for each test <strong>group</strong> are generated and can be used to check if a proctor-result contains the specified <strong>test bucket</strong>.

### Generated ExampleGroups.js

<pre>
  <code class="javascript">
define('com.indeed.example.groups', [], function() {

  var ExampleGroups_ = function(opt_values) {
    if (opt_values) {
      var testDef;
      testDef = opt_values[0];
      this.bgcolortstValue_ = testDef[0];
    } else {
      this.bgcolortstValue_ = -1;
    }
  };


  // BGCOLORTST

  ExampleGroups_.prototype.bgcolortstValue_;

  ExampleGroups_.prototype.isBgcolortstInactive = function() {
    return this.bgcolortstValue_ === -1;
  };

  ExampleGroups_.prototype.isBgcolortstAltcolor1 = function() {
    return this.bgcolortstValue_ === 0;
  };

  ExampleGroups_.prototype.isBgcolortstAltcolor2 = function() {
    return this.bgcolortstValue_ === 1;
  };

  ExampleGroups_.prototype.isBgcolortstAltcolor3 = function() {
    return this.bgcolortstValue_ === 2;
  };

  ExampleGroups_.prototype.isBgcolortstAltcolor4 = function() {
    return this.bgcolortstValue_ === 3;
  };


  var groups_ = null;

  return {

    init: function(values) {
      groups_ = new ExampleGroups_(values);
      return groups_;
    },

    getGroups: function() {
      if (groups_ == null) {
        groups_ = new ExampleGroups_();
      }
      return groups_;
    }

  };
});

</code></pre>

<h3>Key points:</h3>

- Functionality of Javascript groups is dependent on using <strong>determineBuckets</strong> in your Java code.
- The value passed to <strong>init()</strong> is an array of bucket allocations and payloads. A method is included in <strong>AbstractGroups</strong> to generate this object.
- A <strong>Google Closure</strong> style generated file is also available.

## <a name="maven"></a>proctor-maven-plugin
The <strong>proctor-maven-plugin</strong> makes it easy to incorporate Java code generation into the [maven build lifecycle](http://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html).

| Goal | Default Phase | Description |
| ---- | ------------- | ----------- |
| `generate` | generate-sources | Generates groups and groups-manager from `src/main/proctor` and adds specification as source resource | 
| `generate-test` | generate-test-sources | Generates groups and groups-manager from `src/test/proctor` and adds specification as test resource |
| `generate-js` | generate-js-sources | Generates groups from `src/main/proctor` and adds specification as source resource |
| `generate-js-test` | generate-js-test-sources | Generates groups from `src/test/proctor` and adds specification as test resource |
<br><br>
The following `plugin` element should be added to your application's `pom.xml` ([complete pom.xml example example](https://gist.github.com/parker/c0ea111ff343f58346e0#file-pom-xml)):

<pre>
<code class="xml">
...
  <plugin>
    <groupId>com.indeed</groupId>
    <artifactId>proctor-maven-plugin</artifactId>
    <version>1.0-SNAPSHOT</version>
    <executions>
      <execution>
        <id>proctor-generate</id>
        <goals>
          <goal>generate</goal>
        </goals>
      </execution>
    </executions>
  </plugin>
...

</code></pre>

The `generate` goal will be executed in the standard compile and build lifecycle. To man manually run the code generator, run the following in a terminal:

<pre>
<code class="bash">
$ mvn com.indeed:proctor-maven-plugin:generate
</code></pre>

By convention, the plugin determines the java package and classname from the specification's path and filename, respectively.

<pre>
<code class="bash">
.
├── src
|   ├── main
|       ├── proctor
|           ├── org/your/company/app/ExampleGroups.json
|   ├── test
|       ├── proctor
|           ├── org/your/company/app/ExampleGroups.json

</code></pre>

<pre>
<code class="bash">
src/main/org/your/company/app/ExampleGroups.json 
    => org.your.company.app.ExampleGroups.java
    => org.your.company.app.ExampleGroupsManager.java
</code></pre>

Alternatively, for a split specification, the format would look like
<pre>
<code class="bash">
.
├── src
|   ├── main
|       ├── org/your/company/app/Example
|           ├── providedcontext.json
|           ├── examplefirsttest.json
|           ├── examplesecondtest.json
|           ├── examplethirdtest.json
|   ├── test
|       ├── org/your/company/app/Example
|           ├── providedcontext.json
|           ├── examplefirsttest.json
|           ├── examplesecondtest.json
|           ├── examplethirdtest.json

</code></pre>

The generated file is sent to target/generated-resources/proctor and must be added separately in the pom.xml for inclusion in classpath resources, this could look like:

<pre>
<code class="bash">
  <build>
   ...
      <resources>
          <resource>
              <directory>${project.build.directory}/generated-resources/proctor</directory>
          </resource>
      </resources>
  </build>

</code></pre>

## <a name="ant"></a>proctor-ant-plugin
The <strong>proctor-ant-plugin</strong> project provides two ant tasks that can be invoked during ant's build process: <ul>
<li><code>com.indeed.proctor.consumer.gen.ant.TestGroupsJavaGeneratorTask</code> is used to generate Java code </li>
<li><code>com.indeed.proctor.consumer.gen.ant.TestGroupsJavascriptGeneratorTask</code> is used to generate Javascript code</li></ul>

[TODO: is the ant task bundled properly? Adjust ant task to use file name and package just like maven plugin?]
<ol>

<li>Add a <em>proctor</em>configuration and <em>>proctor-ant-plugin</em> dependency to your application's <em>ivy.xml</em>

  <pre>
<code class="xml">
    <configurations defaultconfmapping="default->default(master)">
        <conf name="compile" extends="default"/>
        <conf name="proctor" extends="compile"/>
    </configurations>

    <dependencies>
        <dependency org="com.indeed" name="proctor-ant-plugin" 
                    rev="1.0-SNAPSHOT" conf="proctor->default" />
    </dependencies>
 
</code></pre></li>

<li>Create specification in your application's <code>src/resources</code> directory

  <pre>
<code class="bash">
    .
    ├── src
    |    resources
    |       ├── org/your/company/app/ExampleGroups.json
  
  </code></pre>

  Alternatively, for a split specification, the format would look like:

<pre>
<code class="bash">
  .
  ├── src
  |   ├── resources
  |       ├── org/your/company/app
  |           ├── providedcontext.json
  |           ├── examplefirsttest.json
  |           ├── examplesecondtest.json
  |           ├── examplethirdtest.json
  
  </code></pre></li>




<li>Add a classpath ref for the <em>proctor</em> configuration and define a ant target for invoking the task. Unlike the maven plugin, the package, groups class name, and groups manager class name must be specified in the ant task. Typically, the <em>compile</em> target depends on the <em>proctor-generate</em> target and the generated-code (in <code>generated-src</code>) is not committed to version-control.

 <pre>
<code class="xml">
    <target name="init" description="Resolve dependencies and set classpaths">
        ...
        <ivy:cachepath pathid="proctor.path"  conf="proctor"/>
        ...
    </target>
    
    <target name="proctor-generate-java" depends="init" description="generates the java Proctor Groups and GroupsManager for the provided specification">
        <mkdir dir="generated-src/java" />
        <taskdef name="proctor-gen" classname="com.indeed.proctor.consumer.gen.ant.TestGroupsJavaGeneratorTask" classpathref="proctor.path" />
        <proctor-gen 
                  input="src/resources/org/your/company/app/ExampleGroups.json"
                  target="generated-src/java"
                  packageName="org.your.company.app"
                  groupsClass="ExampleGroups"
                  groupsManagerClass="ExampleGroupsManager"/>
    </target>

    <target name="proctor-generate-js" depends="init" description="generates the javascript Proctor Groups for the provided specification">
        <taskdef name="proctor-js-gen" classname="com.indeed.proctor.consumer.gen.ant.TestGroupsJavascriptGeneratorTask" classpathref="proctor.path" />
        <proctor-js-gen
                input="src/resources/org/your/company/app/ExampleGroups.json"
                target="generated-src/js"
                packageName="org.your.company.app"
                groupsClass="ExampleGroups"
                useClosure="false"/>

        </target>

    <target name="compile" depends="proctor-generate-java">
      ...
    </target>

    <target name="makeweb" depends="proctor-generate-js">
          ...
    </target>
 
 </code></pre></li>

  See [example ivy.xml and build.xml gist](https://gist.github.com/parker/9eebd91fcb57ea416c6a) for a complete example

  However, for a split specification the _proctor-gen_ task must be called with the input parameter as the containing folder of the jsons, and with the extra parameter `specificationOutput` as the output 
  
  ```xml
        <proctor-gen 
                  input="src/resources/org/your/company/app"
                  target="generated-src/java"
                  specificationOutput="generated-src/resources"
                  packageName="org.your.company.app"
                  groupsClass="ExampleGroups"
                  groupsManagerClass="ExampleGroupsManager"/>
  ```


[Loader]: {{ site.baseurl }}/docs/loader
